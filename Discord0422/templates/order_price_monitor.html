<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单价格监控</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.bootstrap5.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        /* 自定义样式 */
        .filter-icon {
            margin-left: 5px;
            cursor: pointer;
            font-size: 14px;
            color: #007bff;
        }
        
        .filter-menu {
            position: absolute;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            min-width: 250px;
            max-width: 350px;
            display: none;
        }
        
        .filtered {
            color: #ff5722;
            font-weight: bold;
        }
        
        .table-header th {
            cursor: pointer;
            position: relative;
            white-space: nowrap;
            background-color: #f8f9fa;
            padding: 10px 8px;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            text-align: center;
        }
        
        .sort-icon {
            margin-left: 5px;
        }
        
        .export-btn {
            margin-right: 10px;
        }
        
        .search-box {
            max-width: 300px;
        }
        
        /* 添加新的样式 */
        .filter-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 5px 0;
            border: 1px solid #eee;
            padding: 5px;
            border-radius: 3px;
            background-color: #fafafa;
        }
        
        .filter-list label {
            display: block;
            padding: 5px;
            margin: 0;
            cursor: pointer;
            border-bottom: 1px dotted #eee;
        }
        
        .filter-list label:hover {
            background-color: #f0f0f0;
        }
        
        .filter-list label:last-child {
            border-bottom: none;
        }
        
        .filter-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .filter-search {
            margin-bottom: 8px;
            padding: 6px 10px;
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
        }
        
        .filter-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #007bff;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .table-responsive {
            overflow-x: auto;
            max-height: 600px;
        }
        
        .table-bordered th, .table-bordered td {
            border: 1px solid #dee2e6;
        }
        
        .direction-long {
            background-color: rgba(40, 167, 69, 0.05);
        }
        
        .direction-short {
            background-color: rgba(220, 53, 69, 0.05);
        }
        
        .badge {
            font-size: 85%;
            padding: 0.25em 0.6em;
        }
        
        .range-filter {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .active-filter {
            color: #ff5722;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .table thead th {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        /* 鼠标悬停行效果 */
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05) !important;
        }
        
        /* 盈亏颜色 */
        .profit-positive {
            color: #28a745;
            font-weight: bold;
        }
        
        .profit-negative {
            color: #dc3545;
            font-weight: bold;
        }
        
        /* 右键菜单样式 */
        .context-menu {
            position: absolute;
            z-index: 1000;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 5px 0;
            min-width: 150px;
        }
        
        .context-menu-item {
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .context-menu-item:hover {
            background-color: #f0f0f0;
        }
        
        .context-menu-item i {
            margin-right: 8px;
        }
        
        /* 整体表格美化 */
        .dataTables_wrapper {
            padding: 0;
            margin-bottom: 2rem;
        }
        
        .dataTables_wrapper .dataTables_length, 
        .dataTables_wrapper .dataTables_filter {
            margin-bottom: 1rem;
        }
        
        /* 表头样式 */
        table.dataTable thead th {
            position: relative;
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            padding: 12px 10px;
            border-bottom: 2px solid #dee2e6;
        }
        
        table.dataTable thead th:after {
            content: '';
            position: absolute;
            right: 0;
            top: 25%;
            height: 50%;
            width: 1px;
            background-color: #dee2e6;
        }
        
        table.dataTable thead th:last-child:after {
            display: none;
        }
        
        /* 表格行样式 */
        table.dataTable tbody tr {
            transition: background-color 0.2s ease;
        }
        
        table.dataTable tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05) !important;
        }
        
        table.dataTable tbody tr.selected {
            background-color: rgba(0, 123, 255, 0.15) !important;
        }
        
        /* 偶数行背景 */
        table.dataTable tbody tr:nth-of-type(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        /* 表格单元格样式 */
        table.dataTable tbody td {
            padding: 10px;
            vertical-align: middle;
            border-bottom: 1px solid #dee2e6;
        }
        
        /* 按钮组样式 */
        .dt-buttons {
            margin-bottom: 1rem;
        }
        
        .dt-button {
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }
        
        /* 分页样式 */
        .dataTables_paginate .paginate_button {
            border-radius: 4px !important;
            margin: 0 2px;
        }
        
        .dataTables_paginate .paginate_button.current {
            background: #0d6efd !important;
            border-color: #0d6efd !important;
            color: white !important;
        }
        
        /* 筛选面板样式 */
        .filter-panel {
            background-color: #f9f9f9;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .filter-panel .form-label {
            font-weight: 600;
            color: #495057;
        }
        
        /* 响应式布局优化 */
        @media (max-width: 768px) {
            .filter-panel .col-md-3,
            .filter-panel .col-md-6 {
                margin-bottom: 1rem;
            }
            
            .dt-buttons {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .dt-button {
                margin-bottom: 0.5rem;
            }
        }
        
        /* 数据为空时的样式 */
        .dataTables_empty {
            padding: 2rem !important;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
        
        /* 订单详情模态框样式 */
        #orderDetailsModal .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        #orderDetailsModal .modal-title {
            font-weight: 600;
            color: #495057;
        }
        
        #orderDetailsModal h5 {
            color: #495057;
            font-weight: 600;
        }
        
        #orderDetailsModal table th {
            width: 40%;
            font-weight: 600;
        }
        
        /* 美化DataTables搜索框并只保留中文标签 */
        .dataTables_filter {
            margin: 0.5rem 0;
            text-align: right;
        }

        .dataTables_filter input {
            padding: 0.375rem 0.75rem;
            font-size: 0.9rem;
            font-weight: 400;
            line-height: 1.5;
            color: #212529;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            width: 250px;
        }

        .dataTables_filter input:focus {
            color: #212529;
            background-color: #fff;
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .dataTables_filter label {
            font-size: 0;  /* 完全隐藏原始文本 */
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        /* 使用before添加单一的"搜索:"文本 */
        .dataTables_filter label:before {
            content: "搜索:";
            margin-right: 0.5rem;
            font-size: 0.9rem;  /* 恢复字体大小 */
            font-weight: normal;
        }

        /* 隐藏DataTables英文标签文本 */
        .dataTables_filter label > span {
            display: none;
        }

        .dataTables_filter label::after {
            content: "";
        }

        /* 隐藏其他英文标签 */
        .dataTables_length label,
        .dataTables_info,
        .dataTables_paginate {
            font-size: 0.9rem;
        }

        /* 添加更多必要的自定义CSS以确保一致性 */
        /* 表头下拉选择框样式 */
        .dataTable thead th select {
            width: auto;
            display: block;
            margin-top: 5px;
            font-size: 0.8rem;
            padding: 2px 5px;
            border-radius: 3px;
            border: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }
        
        .dataTable thead th {
            position: relative;
            white-space: nowrap;
            padding-right: 20px;
            min-height: 60px;
            line-height: 1.2;
        }
        
        .dataTable thead th select:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="text-center mb-4" id="main-title">订单与价格实时监控</h1>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 id="control-panel-title">控制面板</h4>
                        <div>
                            <select id="intervalSelect" class="form-select d-inline-block" style="width: 100px;">
                                <option value="1">1秒</option>
                                <option value="3" selected>3秒</option>
                                <option value="5">5秒</option>
                                <option value="10">10秒</option>
                            </select>
                            <button id="startBtn" class="btn btn-success ms-2">开始</button>
                            <button id="stopBtn" class="btn btn-danger ms-2">停止</button>
                            <button id="refreshBtn" class="btn btn-info ms-2">刷新</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            状态: <span id="statusText">已连接</span> | 
                            最后更新: <span id="lastUpdate">--</span> |
                            更新间隔: <span id="currentInterval">3秒</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 id="order-stats-title">订单统计</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h5>活跃订单: <span id="activeOrderCount">0</span></h5>
                            </div>
                            <div class="col-6">
                                <h5>完成订单: <span id="completedOrderCount">0</span></h5>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <h5>多单: <span id="longOrderCount">0</span></h5>
                            </div>
                            <div class="col-6">
                                <h5>空单: <span id="shortOrderCount">0</span></h5>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <h5>当前盈亏: <span id="currentPnL">-</span></h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h4 id="realtime-price-title">实时价格</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-header" id="price-table-header">
                                    <tr>
                                        <th>交易对</th>
                                        <th>最新价格</th>
                                        <th>买入价</th>
                                        <th>卖出价</th>
                                        <th>24小时变化</th>
                                        <th>更新时间</th>
                                    </tr>
                                </thead>
                                <tbody id="priceTableBody">
                                    <tr id="BTCUSDT-row">
                                        <td><strong>BTC/USDT</strong></td>
                                        <td id="BTCUSDT-mid">--</td>
                                        <td id="BTCUSDT-bid">--</td>
                                        <td id="BTCUSDT-ask">--</td>
                                        <td id="BTCUSDT-change">--</td>
                                        <td id="BTCUSDT-time">--</td>
                                    </tr>
                                    <tr id="ETHUSDT-row">
                                        <td><strong>ETH/USDT</strong></td>
                                        <td id="ETHUSDT-mid">--</td>
                                        <td id="ETHUSDT-bid">--</td>
                                        <td id="ETHUSDT-ask">--</td>
                                        <td id="ETHUSDT-change">--</td>
                                        <td id="ETHUSDT-time">--</td>
                                    </tr>
                                    <tr id="SOLUSDT-row">
                                        <td><strong>SOL/USDT</strong></td>
                                        <td id="SOLUSDT-mid">--</td>
                                        <td id="SOLUSDT-bid">--</td>
                                        <td id="SOLUSDT-ask">--</td>
                                        <td id="SOLUSDT-change">--</td>
                                        <td id="SOLUSDT-time">--</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <ul class="nav nav-tabs mb-4" id="orderTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="active-orders-tab" data-bs-toggle="tab" data-bs-target="#active-orders" type="button" role="tab">活跃订单</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="completed-orders-tab" data-bs-toggle="tab" data-bs-target="#completed-orders" type="button" role="tab">已完成订单</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="price-chart-tab" data-bs-toggle="tab" data-bs-target="#price-chart" type="button" role="tab">价格图表</button>
            </li>
        </ul>
        
        <div class="tab-content" id="orderTabContent">
            <div class="tab-pane fade show active" id="active-orders" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title m-0" id="active-orders-title">活跃订单</h5>
                        <button id="refreshData" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-arrow-clockwise"></i> 刷新数据
                                </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3" id="activeOrdersFilters">
                            <!-- 动态筛选器将在这里添加 -->
                        </div>
                        <div class="table-responsive">
                            <table id="activeOrdersTable" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>频道</th>
                                        <th>交易币种</th>
                                        <th>方向</th>
                                        <th>发布时间</th>
                                        <th>入场点位1</th>
                                        <th>止损点位1</th>
                                        <th>止盈点位1</th>
                                        <th>总计加权收益%</th>
                                        <th>结果</th>
                                        <th>均持仓时间</th>
                                        <th>风险收益比</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 数据将通过DataTables动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="completed-orders" role="tabpanel">
                <div class="card mt-4">
                    <div class="card-body">
                        <!-- 删除按钮组 -->
                        <div class="row mb-3" id="completedOrdersFilters">
                            <!-- 动态筛选器将在这里添加 -->
                        </div>
                        <div class="table-responsive">
                            <table id="completedOrdersTable" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>频道</th>
                                        <th>交易币种</th>
                                        <th>方向</th>
                                        <th>发布时间</th>
                                        <th>入场点位1</th>
                                        <th>止损点位1</th>
                                        <th>止盈点位1</th>
                                        <th>总计加权收益%</th>
                                        <th>结果</th>
                                        <th>均持仓时间</th>
                                        <th>风险收益比</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 数据将通过DataTables动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="price-chart" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <h4 id="price-chart-title">价格历史图表</h4>
                            </div>
                            <div class="card-body">
                                <div class="btn-group mb-3">
                                    <button class="btn btn-outline-primary active" data-symbol="BTCUSDT">BTC</button>
                                    <button class="btn btn-outline-primary" data-symbol="ETHUSDT">ETH</button>
                                    <button class="btn btn-outline-primary" data-symbol="SOLUSDT">SOL</button>
                                </div>
                                <div style="height: 400px;">
                                    <canvas id="priceChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 筛选菜单模板 -->
    <div id="filter-menu-template" class="filter-menu" style="display: none;">
        <div class="filter-title">筛选 - <span class="filter-field-name"></span></div>
        <input type="text" class="filter-search" placeholder="搜索筛选项...">
        <div class="filter-list">
            <!-- 选项将动态添加 -->
        </div>
        <div class="filter-counter mt-1 mb-2 small text-muted">
            已选择: <span class="selected-count">0</span> / <span class="total-count">0</span>
        </div>
        <div class="filter-actions">
            <button class="btn btn-sm btn-outline-secondary filter-clear">清除</button>
            <div>
                <button class="btn btn-sm btn-outline-primary filter-select-all me-1">全选</button>
                <button class="btn btn-sm btn-primary filter-apply">应用</button>
            </div>
        </div>
    </div>

    <!-- 修复jQuery和库加载顺序，移除不需要的库 -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.6.1/dist/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // jQuery就绪后初始化DataTables
        $(document).ready(function() {
            console.log('jQuery就绪，初始化应用...');
            
            // 初始化应用
            initApp();
            
            // 添加一些测试数据（仅用于本地开发）
            addTestData();
            
            // 客户端启动后立即发送刷新和开始监控请求
            requestInitialData();
        });
        
        // 初始化应用
        function initApp() {
            // 标题配置应用
            applyTitleConfig();
            
            // 初始化图表
            initChart('BTCUSDT');
            
            // 设置各种UI功能
            setupTableSorting();
            setupSearchBox();
            setupExportButtons();
            setupFilterMenus();
            
            // 初始化表格
            initializeDataTables();
            
            // 绑定控制按钮事件
            bindControlEvents();
        }
        
        // 请求初始数据
        function requestInitialData() {
            console.log('请求初始数据...');
            setTimeout(() => {
                // 请求刷新数据
                socket.emit('refresh_data');
                console.log('已发送refresh_data请求');
                
                // 请求开始监控
                socket.emit('start_monitoring');
                console.log('已发送start_monitoring请求');
            }, 1000);
        }
        
        // 绑定控制按钮事件
        function bindControlEvents() {
            // 控制按钮
            $('#startBtn').on('click', function() {
                console.log('点击了开始按钮');
                socket.emit('start_monitoring');
            });
            
            $('#stopBtn').on('click', function() {
                console.log('点击了停止按钮');
                socket.emit('stop_monitoring');
            });
            
            $('#refreshBtn').on('click', function() {
                console.log('点击了刷新按钮');
                socket.emit('refresh_data');
            });
            
            $('#setIntervalBtn').on('click', function() {
                const interval = $('#pollingInterval').val();
                console.log('设置间隔为:', interval);
                socket.emit('set_interval', { interval: interval });
            });
        }
        
        // 添加测试数据（仅用于开发测试）
        function addTestData() {
            state.activeOrders = [
                {
                    id: 1,
                    channel: "频道A",
                    symbol: "BTCUSDT", 
                    direction: "多",
                    publish_time: new Date().toISOString(),
                    entry_price: 64500,
                    exit_price: 65200,
                    exit_time: null,
                    stop_loss: 63000,
                    target_price: 68000,
                    profit_pct: 1.08,
                    hold_time: 4.5,
                    risk_reward_ratio: 2.33
                },
                {
                    id: 2,
                    channel: "频道B",
                    symbol: "ETHUSDT",
                    direction: "空",
                    publish_time: new Date().toISOString(),
                    entry_price: 3200,
                    exit_price: 3100,
                    exit_time: null,
                    stop_loss: 3300,
                    target_price: 2900,
                    profit_pct: 3.12,
                    hold_time: 6.2,
                    risk_reward_ratio: 1.45
                }
            ];

            state.completedOrders = [
                {
                    id: 3,
                    channel: "频道A",
                    symbol: "SOLUSDT", 
                    direction: "多",
                    publish_time: "2023-04-15T10:30:00Z",
                    entry_price: 120,
                    exit_price: 140,
                    exit_time: "2023-04-16T15:45:00Z",
                    stop_loss: 110,
                    target_price: 150,
                    profit_pct: 16.67,
                    hold_time: 29.25,
                    risk_reward_ratio: 2.0
                },
                {
                    id: 4,
                    channel: "频道C",
                    symbol: "BTCUSDT",
                    direction: "空",
                    publish_time: "2023-04-12T08:15:00Z",
                    entry_price: 68000,
                    exit_price: 65000,
                    exit_time: "2023-04-13T09:30:00Z",
                    stop_loss: 70000,
                    target_price: 62000,
                    profit_pct: 4.41,
                    hold_time: 25.25,
                    risk_reward_ratio: 1.5
                }
            ];
        }

        // 应用标题配置
        function applyTitleConfig() {
            // 设置主标题
            document.getElementById('main-title').textContent = title_config.main_title;
            
            // 设置各卡片标题
            document.getElementById('control-panel-title').textContent = title_config.control_panel_title;
            document.getElementById('order-stats-title').textContent = title_config.order_stats_title;
            document.getElementById('realtime-price-title').textContent = title_config.realtime_price_title;
            document.getElementById('active-orders-title').textContent = title_config.active_orders_title;
            document.getElementById('completed-orders-title').textContent = title_config.completed_orders_title;
            document.getElementById('price-chart-title').textContent = title_config.price_chart_title;
            
            // 设置价格表格表头
            const priceTableHeader = document.querySelector('#price-table-header tr');
            if (priceTableHeader) {
                priceTableHeader.innerHTML = `
                    <th>${title_config.price_table_header.symbol}</th>
                    <th>${title_config.price_table_header.mid_price}</th>
                    <th>${title_config.price_table_header.bid_price}</th>
                    <th>${title_config.price_table_header.ask_price}</th>
                    <th>${title_config.price_table_header.change_24h}</th>
                    <th>${title_config.price_table_header.update_time}</th>
                `;
            }
        }

        // 设置表格排序
        function setupTableSorting() {
            console.log('设置表格排序功能');
            // 此函数已被DataTables取代，保留空函数避免错误
        }

        // 设置搜索框
        function setupSearchBox() {
            console.log('设置表格搜索功能');
            // DataTables已提供搜索功能，我们只需绑定现有UI元素
            
            // 活跃订单搜索
            $('#activeOrderSearch').on('keyup', function() {
                if (activeOrdersTable) {
                    activeOrdersTable.search(this.value).draw();
                }
            });
            
            // 已完成订单搜索
            $('#completedOrderSearch').on('keyup', function() {
                if (completedOrdersTable) {
                    completedOrdersTable.search(this.value).draw();
                }
            });
            
            // 清除搜索
            $('#clearActiveSearch').on('click', function() {
                $('#activeOrderSearch').val('');
                if (activeOrdersTable) {
                    activeOrdersTable.search('').draw();
                }
            });
            
            $('#clearCompletedSearch').on('click', function() {
                $('#completedOrderSearch').val('');
                if (completedOrdersTable) {
                    completedOrdersTable.search('').draw();
                }
            });
        }

        // 设置导出按钮
        function setupExportButtons() {
            console.log('设置表格导出功能');
            // DataTables已提供导出功能，我们只需绑定现有UI元素
            
            // 活跃订单导出
            $('#exportActiveOrders').on('click', function() {
                if (activeOrdersTable) {
                    // 触发Excel导出按钮
                    activeOrdersTable.button('.buttons-excel').trigger();
                }
            });
            
            // 已完成订单导出
            $('#exportCompletedOrders').on('click', function() {
                if (completedOrdersTable) {
                    // 触发Excel导出按钮
                    completedOrdersTable.button('.buttons-excel').trigger();
                }
            });
            
            // 清除筛选
            $('#clearActiveFilters').on('click', function() {
                if (activeOrdersTable) {
                    activeOrdersTable.search('').columns().search('').draw();
                }
            });
            
            $('#clearCompletedFilters').on('click', function() {
                if (completedOrdersTable) {
                    completedOrdersTable.search('').columns().search('').draw();
                }
            });
        }

        // 确保从服务器获取真实数据
        $(document).ready(function() {
            console.log('开始连接WebSocket获取真实数据...');
            
            // 格式化日期时间函数
            function formatDateTime(dateTimeStr) {
                if (!dateTimeStr) return '-';
                
                try {
                    const date = new Date(dateTimeStr);
                    if (isNaN(date.getTime())) return dateTimeStr;
                    
                    // 格式化为：YYYY-MM-DD HH:MM
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                } catch (e) {
                    return dateTimeStr;
                }
            }
            
            // 格式化持仓时间函数 - 显示小时
            function formatHoldingTime(hours) {
                if (!hours || isNaN(hours)) return '-';
                
                // 显示小时，保留一位小数
                return `${hours.toFixed(1)}小时`;
            }

            // 连接WebSocket
            const socket = io();
            let activeOrdersTable, completedOrdersTable;
            let activeOrders = [], completedOrders = [];
            
            // 从服务器请求刷新数据
            socket.emit('refresh_data');
            
            // 监听订单数据更新
            socket.on('orders_update', function(data) {
                console.log('收到订单数据:', data);
                
                if (data.active_orders && Array.isArray(data.active_orders)) {
                    activeOrders = data.active_orders;
                    console.log(`收到 ${activeOrders.length} 条活跃订单数据`);
                }
                
                if (data.completed_orders && Array.isArray(data.completed_orders)) {
                    // 修复字段名称不一致问题
                    completedOrders = data.completed_orders.map(order => {
                        // 如果有risk_reward但没有risk_reward_ratio，则复制过来
                        if (order.risk_reward !== undefined && order.risk_reward_ratio === undefined) {
                            order.risk_reward_ratio = order.risk_reward;
                        }
                        return order;
                    });
                    console.log(`收到 ${completedOrders.length} 条已完成订单数据`);
                }
                
                // 初始化或更新表格
                initOrUpdateTables();
            });
            
            // 初始化或更新表格
            function initOrUpdateTables() {
                // 初始化活跃订单表格
                if ($.fn.DataTable.isDataTable('#activeOrdersTable')) {
                    activeOrdersTable.clear().rows.add(activeOrders).draw();
                    console.log('更新活跃订单表格数据');
                } else {
                    try {
                        console.log('初始化活跃订单表格...');
                        activeOrdersTable = $('#activeOrdersTable').DataTable({
                            data: activeOrders,
                            responsive: true,
                            dom: '<"top"f>rt<"bottom"ilp>', // 自定义DOM布局，保留搜索框
                            lengthMenu: [[20, 50, 100, -1], [20, 50, 100, "全部"]],
                            pageLength: 20,
                            language: dataTablesLanguage, // 使用自定义语言配置而不是远程JSON
                            columns: [
                                { data: 'channel', title: '频道' },
                                { data: 'symbol', title: '交易币种' },
                                { 
                                    data: 'direction', 
                                    title: '方向',
                                    render: function(data, type, row) {
                                        if (type === 'display') {
                                            const badgeClass = data === '多' ? 'bg-success' : 'bg-danger';
                                            return `<span class="badge ${badgeClass}">${data}</span>`;
                                        }
                                        return data;
                                    }
                                },
                                { 
                                    data: 'publish_time', 
                                    title: '发布时间',
                                    render: function(data, type) {
                                        if (type === 'display' || type === 'filter') {
                                            return formatDateTime(data);
                                        }
                                        return data;
                                    }
                                },
                                { data: 'entry_price', title: '入场点位1' },
                                { data: 'stop_loss', title: '止损点位1' },
                                { data: 'target_price', title: '止盈点位1' },
                                { 
                                    data: 'profit_pct', 
                                    title: '总计加权收益%',
                                    render: function(data) {
                                        if (data) {
                                            const cls = data >= 0 ? 'text-success' : 'text-danger';
                                            return `<span class="${cls}">${data.toFixed(2)}%</span>`;
                                        }
                                        return '-';
                                    }
                                },
                                {
                                    data: 'result',
                                    title: '结果',
                                    render: function(data) {
                                        return data || '-';
                                    }
                                },
                                { 
                                    data: 'hold_time', 
                                    title: '均持仓时间',
                                    render: function(data, type) {
                                        // 用于排序和过滤的数据
                                        if (type === 'sort' || type === 'type') {
                                            return data;  // 返回原始数值用于排序
                                        }
                                        // 用于显示的数据
                                        return formatHoldingTime(data);
                                    }
                                },
                                { 
                                    data: 'risk_reward_ratio', 
                                    title: '风险收益比',
                                    render: function(data) {
                                        return data ? data.toFixed(2) : '-';
                                    }
                                },
                                {
                                    data: null,
                                    title: '操作',
                                    orderable: false,
                                    render: function(data, type, row) {
                                        return `
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary view-details" data-id="${row.id}">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary edit-order" data-id="${row.id}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                            </div>
                                        `;
                                    }
                                }
                            ],
                            columnDefs: [
                                {
                                    "className": "dt-center",
                                    "targets": "_all"
                                }
                            ],
                            order: [[3, 'desc']], // 默认按发布时间降序排序
                            // 移除 buttons 配置
                            initComplete: function() {
                                // 为除了最后一列（操作列）外的每一列添加过滤器
                                this.api().columns().every(function(index) {
                                    // 不对操作列添加过滤器
                                    if (index === this.api().columns().nodes().length - 1) {
                                        return;
                                    }
                                    
                                    const column = this;
                                    const title = $(column.header()).text().trim();
                                    
                                    // 创建下拉框
                                    const select = $('<select class="form-select form-select-sm"><option value="">全部</option></select>')
                                        .appendTo($(column.header()).empty().append(title))
                                        .on('change', function() {
                                            const val = $.fn.dataTable.util.escapeRegex($(this).val());
                                            column
                                                .search(val ? `^${val}$` : '', true, false)
                                                .draw();
                                        });
                                    
                                    // 添加选项
                                    column.data().unique().sort().each(function(d, j) {
                                        if (d) {
                                            // 对于有格式的数据（如日期、百分比等），使用纯文本
                                            let displayText = d;
                                            if (typeof d === 'string' && d.includes('<span')) {
                                                // 从HTML中提取文本
                                                const tempDiv = document.createElement('div');
                                                tempDiv.innerHTML = d;
                                                displayText = tempDiv.textContent || tempDiv.innerText || d;
                                            }
                                            select.append(`<option value="${d}">${displayText}</option>`);
                                        }
                                    });
                                });
                            }
                        });
                        console.log('活跃订单表格初始化完成');
                    } catch (e) {
                        console.error('初始化活跃订单表格出错:', e);
                    }
                }
                
                // 初始化已完成订单表格
                if ($.fn.DataTable.isDataTable('#completedOrdersTable')) {
                    completedOrdersTable.clear().rows.add(completedOrders).draw();
                    console.log('更新已完成订单表格数据');
                } else {
                    try {
                        console.log('初始化已完成订单表格...');
                        completedOrdersTable = $('#completedOrdersTable').DataTable({
                            data: completedOrders,
                            responsive: true,
                            dom: '<"top"f>rt<"bottom"ilp>', // 简单布局
                            lengthMenu: [[20, 50, 100, -1], [20, 50, 100, "全部"]],
                            pageLength: 20,
                            language: dataTablesLanguage,
                            columns: [
                                { data: 'channel', title: '频道' },
                                { data: 'symbol', title: '交易币种' },
                                { 
                                    data: 'direction', 
                                    title: '方向',
                                    render: function(data, type, row) {
                                        if (type === 'display') {
                                            const badgeClass = data === '多' ? 'bg-success' : 'bg-danger';
                                            return `<span class="badge ${badgeClass}">${data}</span>`;
                                        }
                                        return data;
                                    }
                                },
                                { 
                                    data: 'publish_time', 
                                    title: '发布时间',
                                    render: function(data, type) {
                                        if (type === 'display' || type === 'filter') {
                                            return formatDateTime(data);
                                        }
                                        return data;
                                    }
                                },
                                { data: 'entry_price', title: '入场点位1' },
                                { data: 'stop_loss', title: '止损点位1' },
                                { data: 'target_price', title: '止盈点位1' },
                                { 
                                    data: 'profit_pct', 
                                    title: '总计加权收益%',
                                    render: function(data) {
                                        if (data) {
                                            const cls = data >= 0 ? 'text-success' : 'text-danger';
                                            return `<span class="${cls}">${data.toFixed(2)}%</span>`;
                                        }
                                        return '-';
                                    }
                                },
                                {
                                    data: 'result',
                                    title: '结果',
                                    render: function(data) {
                                        return data || '-';
                                    }
                                },
                                { 
                                    data: 'hold_time', 
                                    title: '均持仓时间',
                                    render: function(data, type) {
                                        // 用于排序和过滤的数据
                                        if (type === 'sort' || type === 'type') {
                                            return data;  // 返回原始数值用于排序
                                        }
                                        // 用于显示的数据
                                        return formatHoldingTime(data);
                                    }
                                },
                                { 
                                    data: 'risk_reward_ratio', 
                                    title: '风险收益比',
                                    render: function(data) {
                                        return data ? data.toFixed(2) : '-';
                                    }
                                },
                                {
                                    data: null,
                                    title: '操作',
                                    orderable: false,
                                    render: function(data, type, row) {
                                        return `
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary view-details" data-id="${row.id}">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary edit-order" data-id="${row.id}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                            </div>
                                        `;
                                    }
                                }
                            ],
                            columnDefs: [
                                {
                                    "className": "dt-center",
                                    "targets": "_all"
                                }
                            ],
                            order: [[3, 'desc']] // 默认按发布时间降序排序
                        });
                        console.log('已完成订单表格初始化完成');
                    } catch (e) {
                        console.error('初始化已完成订单表格出错:', e);
                    }
                }
                
                // 添加行选择效果
                $('#activeOrdersTable tbody').on('click', 'tr', function() {
                    if ($(this).hasClass('selected')) {
                        $(this).removeClass('selected');
                    } else {
                        activeOrdersTable.$('tr.selected').removeClass('selected');
                        $(this).addClass('selected');
                    }
                });
                
                $('#completedOrdersTable tbody').on('click', 'tr', function() {
                    if ($(this).hasClass('selected')) {
                        $(this).removeClass('selected');
                    } else {
                        completedOrdersTable.$('tr.selected').removeClass('selected');
                        $(this).addClass('selected');
                    }
                });
                
                // 添加行详情功能
                $('#activeOrdersTable tbody').on('click', '.view-details', function() {
                    const data = activeOrdersTable.row($(this).closest('tr')).data();
                    showOrderDetails(data);
                });
                
                $('#completedOrdersTable tbody').on('click', '.view-details', function() {
                    const data = completedOrdersTable.row($(this).closest('tr')).data();
                    showOrderDetails(data);
                });
                
                // 绑定刷新按钮事件
                $('#refreshData').off('click').on('click', function() {
                    socket.emit('refresh_data');
                    console.log('请求刷新数据');
                });
            }
            
            // 订阅监控状态更新
            socket.on('monitoring_status', function(data) {
                console.log('收到监控状态:', data);
            });
            
            // 5秒后再次请求数据（以防第一次请求失败）
            setTimeout(function() {
                socket.emit('refresh_data');
                console.log('再次请求数据');
            }, 5000);
        });

        // 自定义DataTables语言配置
        const dataTablesLanguage = {
            "processing": "处理中...",
            "lengthMenu": "显示 _MENU_ 条",
            "zeroRecords": "没有匹配结果",
            "info": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
            "infoEmpty": "显示第 0 至 0 项结果，共 0 项",
            "infoFiltered": "(由 _MAX_ 项结果过滤)",
            "search": "", // 移除搜索标签
            "emptyTable": "表中数据为空",
            "paginate": {
                "first": "首页",
                "previous": "上页",
                "next": "下页",
                "last": "末页"
            },
            "aria": {
                "sortAscending": ": 以升序排列此列",
                "sortDescending": ": 以降序排列此列"
            },
            "thousands": ","
        };

        // 用于初始化DataTables的配置
        function initOrUpdateTables() {
            // 初始化活跃订单表格
            if ($.fn.DataTable.isDataTable('#activeOrdersTable')) {
                activeOrdersTable.clear().rows.add(activeOrders).draw();
                console.log('更新活跃订单表格数据');
            } else {
                try {
                    console.log('初始化活跃订单表格...');
                    activeOrdersTable = $('#activeOrdersTable').DataTable({
                        data: activeOrders,
                        responsive: true,
                        dom: '<"top"f>rt<"bottom"ilp>', // 自定义DOM布局，保留搜索框
                        lengthMenu: [[20, 50, 100, -1], [20, 50, 100, "全部"]],
                        pageLength: 20,
                        language: dataTablesLanguage, // 使用自定义语言配置而不是远程JSON
                        columns: [
                            { data: 'channel', title: '频道' },
                            { data: 'symbol', title: '交易币种' },
                            { 
                                data: 'direction', 
                                title: '方向',
                                render: function(data, type, row) {
                                    if (type === 'display') {
                                        const badgeClass = data === '多' ? 'bg-success' : 'bg-danger';
                                        return `<span class="badge ${badgeClass}">${data}</span>`;
                                    }
                                    return data;
                                }
                            },
                            { 
                                data: 'publish_time', 
                                title: '发布时间',
                                render: function(data, type) {
                                    if (type === 'display' || type === 'filter') {
                                        return formatDateTime(data);
                                    }
                                    return data;
                                }
                            },
                            { data: 'entry_price', title: '入场点位1' },
                            { data: 'stop_loss', title: '止损点位1' },
                            { data: 'target_price', title: '止盈点位1' },
                            { 
                                data: 'profit_pct', 
                                title: '总计加权收益%',
                                render: function(data) {
                                    if (data) {
                                        const cls = data >= 0 ? 'text-success' : 'text-danger';
                                        return `<span class="${cls}">${data.toFixed(2)}%</span>`;
                                    }
                                    return '-';
                                }
                            },
                            {
                                data: 'result',
                                title: '结果',
                                render: function(data) {
                                    return data || '-';
                                }
                            },
                            { 
                                data: 'hold_time', 
                                title: '均持仓时间',
                                render: function(data, type) {
                                    // 用于排序和过滤的数据
                                    if (type === 'sort' || type === 'type') {
                                        return data;  // 返回原始数值用于排序
                                    }
                                    // 用于显示的数据
                                    return formatHoldingTime(data);
                                }
                            },
                            { 
                                data: 'risk_reward_ratio', 
                                title: '风险收益比',
                                render: function(data) {
                                    return data ? data.toFixed(2) : '-';
                                }
                            },
                            {
                                data: null,
                                title: '操作',
                                orderable: false,
                                render: function(data, type, row) {
                                    return `
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary view-details" data-id="${row.id}">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary duplicate-order" data-id="${row.id}">
                                                <i class="bi bi-files"></i>
                                            </button>
                                        </div>
                                    `;
                                }
                            }
                        ],
                        columnDefs: [
                            {
                                "className": "dt-center",
                                "targets": "_all"
                            }
                        ],
                        order: [[3, 'desc']] // 默认按发布时间降序排序
                    });
                    console.log('活跃订单表格初始化完成');
                } catch (e) {
                    console.error('初始化活跃订单表格出错:', e);
                }
            }
            
            // 初始化已完成订单表格
            if ($.fn.DataTable.isDataTable('#completedOrdersTable')) {
                completedOrdersTable.clear().rows.add(completedOrders).draw();
                console.log('更新已完成订单表格数据');
            } else {
                try {
                    console.log('初始化已完成订单表格...');
                    completedOrdersTable = $('#completedOrdersTable').DataTable({
                        data: completedOrders,
                        responsive: true,
                        dom: '<"top"f>rt<"bottom"ilp>', // 简单布局
                        lengthMenu: [[20, 50, 100, -1], [20, 50, 100, "全部"]],
                        pageLength: 20,
                        language: dataTablesLanguage,
                        columns: [
                            { data: 'channel', title: '频道' },
                            { data: 'symbol', title: '交易币种' },
                            { 
                                data: 'direction', 
                                title: '方向',
                                render: function(data, type, row) {
                                    if (type === 'display') {
                                        const badgeClass = data === '多' ? 'bg-success' : 'bg-danger';
                                        return `<span class="badge ${badgeClass}">${data}</span>`;
                                    }
                                    return data;
                                }
                            },
                            { 
                                data: 'publish_time', 
                                title: '发布时间',
                                render: function(data, type) {
                                    if (type === 'display' || type === 'filter') {
                                        return formatDateTime(data);
                                    }
                                    return data;
                                }
                            },
                            { data: 'entry_price', title: '入场点位1' },
                            { data: 'stop_loss', title: '止损点位1' },
                            { data: 'target_price', title: '止盈点位1' },
                            { 
                                data: 'profit_pct', 
                                title: '总计加权收益%',
                                render: function(data) {
                                    if (data) {
                                        const cls = data >= 0 ? 'text-success' : 'text-danger';
                                        return `<span class="${cls}">${data.toFixed(2)}%</span>`;
                                    }
                                    return '-';
                                }
                            },
                            {
                                data: 'result',
                                title: '结果',
                                render: function(data) {
                                    return data || '-';
                                }
                            },
                            { 
                                data: 'hold_time', 
                                title: '均持仓时间',
                                render: function(data, type) {
                                    // 用于排序和过滤的数据
                                    if (type === 'sort' || type === 'type') {
                                        return data;  // 返回原始数值用于排序
                                    }
                                    // 用于显示的数据
                                    return formatHoldingTime(data);
                                }
                            },
                            { 
                                data: 'risk_reward_ratio', 
                                title: '风险收益比',
                                render: function(data) {
                                    return data ? data.toFixed(2) : '-';
                                }
                            },
                            {
                                data: null,
                                title: '操作',
                                orderable: false,
                                render: function(data, type, row) {
                                    return `
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-primary view-details" data-id="${row.id}">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary duplicate-order" data-id="${row.id}">
                                                <i class="bi bi-files"></i>
                                            </button>
                                        </div>
                                    `;
                                }
                            }
                        ],
                        columnDefs: [
                            {
                                "className": "dt-center",
                                "targets": "_all"
                            }
                        ],
                        order: [[3, 'desc']] // 默认按发布时间降序排序
                    });
                    console.log('已完成订单表格初始化完成');
                } catch (e) {
                    console.error('初始化已完成订单表格出错:', e);
                }
            }
        }

        // 标题配置和基础设置变量
        const title_config = {
            // 页面标题
            main_title: "订单与价格实时监控系统",
            // 控制面板
            control_panel_title: "控制面板",
            // 订单统计
            order_stats_title: "订单统计",
            // 实时价格
            realtime_price_title: "实时价格数据",
            // 价格表头
            price_table_header: {
                symbol: "交易对",
                mid_price: "最新价格",
                bid_price: "买入价",
                ask_price: "卖出价",
                change_24h: "24小时变化",
                update_time: "更新时间"
            },
            // 活跃订单
            active_orders_title: "活跃订单",
            // 活跃订单表头
            active_orders_table_header: {
                channel: "频道",
                symbol: "交易币种",
                direction: "方向",
                publish_time: "发布时间",
                entry_price: "入场点位1",
                stop_loss: "止损点位1",
                target_price: "止盈点位1",
                profit_pct: "总计加权收益%",
                result: "结果",
                hold_time: "均持仓时间",
                risk_reward_ratio: "风险收益比"
            },
            // 已完成订单
            completed_orders_title: "已完成订单",
            // 已完成订单表头
            completed_orders_table_header: {
                channel: "频道",
                symbol: "交易币种",
                direction: "方向",
                publish_time: "发布时间",
                entry_price: "入场点位1",
                stop_loss: "止损点位1",
                target_price: "止盈点位1",
                profit_pct: "总计加权收益%",
                result: "结果",
                hold_time: "均持仓时间",
                risk_reward_ratio: "风险收益比"
            },
            // 价格图表
            price_chart_title: "价格历史图表"
        };
        
        // Socket.io连接
        const socket = io();
        
        // 数据存储对象
        const state = {
            prices: {
                "BTCUSDT": { mid: null, bid: null, ask: null, time: null, history: [] },
                "ETHUSDT": { mid: null, bid: null, ask: null, time: null, history: [] },
                "SOLUSDT": { mid: null, bid: null, ask: null, time: null, history: [] }
            },
            activeOrders: [],
            completedOrders: [],
            isMonitoring: true,
            lastUpdate: null,
            currentChart: null,
            activeSymbol: "BTCUSDT"
        };
        
        // 重要：处理价格数据更新
        socket.on('price_update', function(price) {
            console.log('收到价格更新:', price);
            
            const symbol = price.symbol;
            // 更新价格数据
            if (!state.prices[symbol]) {
                state.prices[symbol] = {
                    history: []
                };
            }
            
            state.prices[symbol].mid = price.mid;
            state.prices[symbol].bid = price.bid;
            state.prices[symbol].ask = price.ask;
            state.prices[symbol].time = price.time;
            state.prices[symbol].change_24h = price.change_24h;
            
            // 更新价格历史
            if (state.prices[symbol].history.length >= 100) {
                state.prices[symbol].history.shift();
            }
            state.prices[symbol].history.push({
                time: new Date(),
                price: price.mid
            });
            
            // 更新DOM元素
            const midElement = document.getElementById(`${symbol}-mid`);
            const bidElement = document.getElementById(`${symbol}-bid`);
            const askElement = document.getElementById(`${symbol}-ask`);
            const timeElement = document.getElementById(`${symbol}-time`);
            const changeElement = document.getElementById(`${symbol}-change`);
            
            console.log(`更新${symbol}价格：`, {
                mid: price.mid,
                bid: price.bid,
                ask: price.ask,
                time: price.time,
                change_24h: price.change_24h
            });
            
            if (midElement) midElement.textContent = price.mid.toFixed(2);
            if (bidElement) bidElement.textContent = price.bid.toFixed(2);
            if (askElement) askElement.textContent = price.ask.toFixed(2);
            if (timeElement) timeElement.textContent = price.time;
            
            if (changeElement) {
                const change = price.change_24h;
                changeElement.textContent = `${change}%`;
                changeElement.className = change >= 0 ? 'text-success' : 'text-danger';
            }
            
            // 更新最后更新时间
            state.lastUpdate = new Date();
            const lastUpdateEl = document.getElementById('lastUpdate');
            if (lastUpdateEl) {
                lastUpdateEl.textContent = state.lastUpdate.toLocaleTimeString();
            }
        });
        
        // 处理批量价格更新
        socket.on('all_prices', function(data) {
            console.log('收到批量价格更新:', data);
            if (data && data.prices && Array.isArray(data.prices)) {
                data.prices.forEach(price => {
                    // 为每个价格触发单独的更新
                    const symbol = price.symbol;
                    if (symbol) {
                        // 更新DOM元素
                        const midElement = document.getElementById(`${symbol}-mid`);
                        const bidElement = document.getElementById(`${symbol}-bid`);
                        const askElement = document.getElementById(`${symbol}-ask`);
                        const timeElement = document.getElementById(`${symbol}-time`);
                        const changeElement = document.getElementById(`${symbol}-change`);
                        
                        if (midElement) midElement.textContent = price.mid.toFixed(2);
                        if (bidElement) bidElement.textContent = price.bid.toFixed(2);
                        if (askElement) askElement.textContent = price.ask.toFixed(2);
                        if (timeElement) timeElement.textContent = price.time;
                        
                        if (changeElement) {
                            const change = price.change_24h;
                            changeElement.textContent = `${change}%`;
                            changeElement.className = change >= 0 ? 'text-success' : 'text-danger';
                        }
                    }
                });
            }
        });
    </script>
</body>
</html> 