<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易订单追踪</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .profit { color: #28a745; font-weight: bold; }
        .loss { color: #dc3545; font-weight: bold; }
        .order-card { border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; transition: transform 0.3s; }
        .order-card:hover { transform: translateY(-5px); }
        .last-update { font-size: 0.8rem; color: #666; }
        .chart-container { height: 200px; margin-top: 20px; }
        .alert-container { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .stats-container { margin-top: 30px; }
        .direction-long { background-color: rgba(40, 167, 69, 0.1); }
        .direction-short { background-color: rgba(220, 53, 69, 0.1); }
        .status-badge { font-size: 0.8rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .status-active { background-color: #17a2b8; color: white; }
        .status-completed { background-color: #6c757d; color: white; }
        
        /* 表头筛选相关样式 */
        th[data-sort] {
            position: relative;
            cursor: pointer;
            padding-right: 35px !important; /* 为图标留出更多空间 */
        }
        
        /* 排序图标 */
        .sort-icon {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* 筛选按钮样式 */
        .filter-icon {
            position: absolute !important;
            right: 5px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            background-color: rgba(255, 255, 255, 0.2) !important;
            border: none !important;
            color: white !important;
            width: 18px !important;
            height: 18px !important;
            font-size: 8px !important;
            padding: 0 !important;
            text-align: center !important;
            line-height: 16px !important;
            border-radius: 3px !important;
            z-index: 100 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            outline: none !important;
        }
        
        .filter-icon:hover {
            background-color: rgba(255, 255, 255, 0.4) !important;
            color: white !important;
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.5) !important;
        }
        
        /* 激活状态的筛选图标 */
        .active-filter {
            background-color: rgba(23, 162, 184, 0.8) !important; /* 使用蓝色表示激活 */
            color: white !important;
            box-shadow: 0 0 5px rgba(23, 162, 184, 0.5) !important;
        }
        
        /* 已筛选的表头 */
        .filtered {
            position: relative;
        }
        
        /* 筛选菜单样式 */
        .filter-menu {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            padding: 15px;
            z-index: 1050;
            min-width: 240px;
            max-width: 320px;
            overflow: auto;
            max-height: 400px;
            margin-top: 10px;
        }
        
        .filter-menu .form-control {
            margin-bottom: 10px;
        }
        
        .filter-menu .form-check {
            margin-bottom: 10px;
        }
        
        .filter-menu .btn {
            font-size: 0.9rem;
            padding: 6px 12px;
        }
        
        .table-header {
            background-color: #212529;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">交易订单追踪系统</h1>
        
        <div class="alert-container" id="alertContainer"></div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>控制面板</h4>
                    </div>
                    <div class="card-body">
                        <div class="d-flex mb-3">
                            <button id="startBtn" class="btn btn-success me-2">开始监控</button>
                            <button id="stopBtn" class="btn btn-danger me-2">停止监控</button>
                            <button id="refreshBtn" class="btn btn-info">刷新数据</button>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="me-2">刷新间隔:</span>
                            <select id="intervalSelect" class="form-select" style="width: 100px;">
                                <option value="1">1秒</option>
                                <option value="3" selected>3秒</option>
                                <option value="5">5秒</option>
                                <option value="10">10秒</option>
                                <option value="30">30秒</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4>订单统计</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h5>活跃订单: <span id="activeOrderCount">{{ active_orders|length }}</span></h5>
                            </div>
                            <div class="col-6">
                                <h5>完成订单: <span id="completedOrderCount">{{ completed_orders|length }}</span></h5>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6">
                                <h5>多单: <span id="longOrderCount">-</span></h5>
                            </div>
                            <div class="col-6">
                                <h5>空单: <span id="shortOrderCount">-</span></h5>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <h5>当前盈亏: <span id="currentPnL">-</span></h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <ul class="nav nav-tabs mb-4" id="orderTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="active-orders-tab" data-bs-toggle="tab" data-bs-target="#active-orders" type="button" role="tab">活跃订单</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="completed-orders-tab" data-bs-toggle="tab" data-bs-target="#completed-orders" type="button" role="tab">已完成订单</button>
            </li>
        </ul>
        
        <div class="tab-content" id="orderTabContent">
            <div class="tab-pane fade show active" id="active-orders" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">活跃订单</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text">交易对</span>
                                    <select id="activeSymbolFilter" class="form-select">
                                        <option value="">全部</option>
                                        <option value="BTCUSDT">BTC</option>
                                        <option value="ETHUSDT">ETH</option>
                                        <option value="SOLUSDT">SOL</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text">频道</span>
                                    <select id="activeChannelFilter" class="form-select">
                                        <option value="">全部</option>
                                        <option value="btc欧阳">btc欧阳</option>
                                        <option value="加密大漂亮">加密大漂亮</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text">方向</span>
                                    <select id="activeDirectionFilter" class="form-select">
                                        <option value="">全部</option>
                                        <option value="多">多</option>
                                        <option value="空">空</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text">状态</span>
                                    <select id="activePnlFilter" class="form-select">
                                        <option value="">全部</option>
                                        <option value="盈利">盈利中</option>
                                        <option value="亏损">亏损中</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3 offset-md-9">
                                <div class="input-group">
                                    <span class="input-group-text">排序</span>
                                    <select id="activeOrderSort" class="form-select">
                                        <option value="time_desc">时间 ↓</option>
                                        <option value="time_asc">时间 ↑</option>
                                        <option value="pnl_desc">盈亏 ↓</option>
                                        <option value="pnl_asc">盈亏 ↑</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-header">
                                    <tr>
                                        <th data-sort="channel">频道</th>
                                        <th data-sort="symbol">交易币种</th>
                                        <th data-sort="direction">方向</th>
                                        <th data-sort="entry_time">入场时间</th>
                                        <th data-sort="entry_price">入场价格</th>
                                        <th data-sort="current_price">当前价格</th>
                                        <th data-sort="stop_loss">止损价格</th>
                                        <th data-sort="target_price">目标价格</th>
                                        <th data-sort="current_pnl">当前盈亏%</th>
                                        <th data-sort="risk_reward">风险收益比</th>
                                        <th data-sort="hold_time">持仓时间</th>
                                    </tr>
                                </thead>
                                <tbody id="active-orders-table">
                                    <!-- 活跃订单将在这里动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="completed-orders" role="tabpanel">
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">已完成订单</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text">交易对</span>
                                    <select id="symbolFilter" class="form-select">
                                        <option value="">全部</option>
                                        <option value="BTCUSDT">BTC</option>
                                        <option value="ETHUSDT">ETH</option>
                                        <option value="SOLUSDT">SOL</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text">频道</span>
                                    <select id="channelFilter" class="form-select">
                                        <option value="">全部</option>
                                        <option value="btc欧阳">btc欧阳</option>
                                        <option value="加密大漂亮">加密大漂亮</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text">方向</span>
                                    <select id="directionFilter" class="form-select">
                                        <option value="">全部</option>
                                        <option value="多">多</option>
                                        <option value="空">空</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-text">结果</span>
                                    <select id="resultFilter" class="form-select">
                                        <option value="">全部</option>
                                        <option value="盈利">盈利</option>
                                        <option value="亏损">亏损</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3 offset-md-9">
                                <div class="input-group">
                                    <span class="input-group-text">排序</span>
                                    <select id="orderSort" class="form-select">
                                        <option value="time_desc">时间 ↓</option>
                                        <option value="time_asc">时间 ↑</option>
                                        <option value="pnl_desc">盈亏 ↓</option>
                                        <option value="pnl_asc">盈亏 ↑</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-header">
                                    <tr>
                                        <th data-sort="channel">频道</th>
                                        <th data-sort="symbol">交易币种</th>
                                        <th data-sort="direction">方向</th>
                                        <th data-sort="entry_time">入场时间</th>
                                        <th data-sort="entry_price">入场价格</th>
                                        <th data-sort="exit_price">出场价格</th>
                                        <th data-sort="exit_time">出场时间</th>
                                        <th data-sort="stop_loss">止损价格</th>
                                        <th data-sort="target_price">目标价格</th>
                                        <th data-sort="profit_pct">盈亏%</th>
                                        <th data-sort="result">结果</th>
                                        <th data-sort="hold_time">持仓时间</th>
                                        <th data-sort="risk_reward">风险收益比</th>
                                    </tr>
                                </thead>
                                <tbody id="completed-orders-table">
                                    <!-- 已完成订单将在这里动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h4>订单分析</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>币种分布</h5>
                            <canvas id="symbolDistributionChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h5>盈亏分布</h5>
                            <canvas id="pnlDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.6.1/dist/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 连接到WebSocket服务器
            const socket = io();
            
            // 状态和数据
            const state = {
                activeOrders: [],
                completedOrders: [],
                isMonitoring: false,
                charts: {},
                lastUpdate: null
            };
            
            // 初始化图表
            function initCharts() {
                // 币种分布图表
                const symbolCtx = document.getElementById('symbolDistributionChart').getContext('2d');
                state.charts.symbolDistribution = new Chart(symbolCtx, {
                    type: 'pie',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
                
                // 盈亏分布图表
                const pnlCtx = document.getElementById('pnlDistributionChart').getContext('2d');
                state.charts.pnlDistribution = new Chart(pnlCtx, {
                    type: 'bar',
                    data: {
                        labels: ['盈利', '亏损'],
                        datasets: [{
                            label: '订单数量',
                            data: [0, 0],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(220, 53, 69, 0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            }
            
            // 更新统计数据
            function updateStats() {
                // 更新订单计数
                document.getElementById('activeOrderCount').textContent = state.activeOrders.length;
                document.getElementById('completedOrderCount').textContent = state.completedOrders.length;
                
                // 统计多空单数量
                const longOrders = [...state.activeOrders, ...state.completedOrders].filter(order => order.direction === '多').length;
                const shortOrders = [...state.activeOrders, ...state.completedOrders].filter(order => order.direction === '空').length;
                document.getElementById('longOrderCount').textContent = longOrders;
                document.getElementById('shortOrderCount').textContent = shortOrders;
                
                // 计算当前总盈亏
                let totalPnl = 0;
                state.activeOrders.forEach(order => {
                    if (order.current_pnl !== null) {
                        totalPnl += order.current_pnl;
                    }
                });
                
                state.completedOrders.forEach(order => {
                    if (order.profit_pct !== null) {
                        totalPnl += order.profit_pct;
                    }
                });
                
                const pnlElement = document.getElementById('currentPnL');
                pnlElement.textContent = totalPnl.toFixed(2) + '%';
                if (totalPnl > 0) {
                    pnlElement.className = 'profit';
                } else if (totalPnl < 0) {
                    pnlElement.className = 'loss';
                } else {
                    pnlElement.className = '';
                }
                
                // 更新图表数据
                updateCharts();
            }
            
            // 更新图表
            function updateCharts() {
                // 更新币种分布图表
                const allOrders = [...state.activeOrders, ...state.completedOrders];
                const symbolCounts = {};
                
                allOrders.forEach(order => {
                    const symbol = order.symbol;
                    if (symbol in symbolCounts) {
                        symbolCounts[symbol]++;
                    } else {
                        symbolCounts[symbol] = 1;
                    }
                });
                
                const symbols = Object.keys(symbolCounts);
                const counts = symbols.map(symbol => symbolCounts[symbol]);
                
                state.charts.symbolDistribution.data.labels = symbols;
                state.charts.symbolDistribution.data.datasets[0].data = counts;
                state.charts.symbolDistribution.update();
                
                // 更新盈亏分布图表
                let profitOrders = 0;
                let lossOrders = 0;
                
                // 活跃订单按当前盈亏计算
                state.activeOrders.forEach(order => {
                    if (order.current_pnl > 0) {
                        profitOrders++;
                    } else if (order.current_pnl < 0) {
                        lossOrders++;
                    }
                });
                
                // 已完成订单按最终盈亏计算
                state.completedOrders.forEach(order => {
                    if (order.profit_pct > 0) {
                        profitOrders++;
                    } else if (order.profit_pct < 0) {
                        lossOrders++;
                    }
                });
                
                state.charts.pnlDistribution.data.datasets[0].data = [profitOrders, lossOrders];
                state.charts.pnlDistribution.update();
            }
            
            // 格式化日期时间
            function formatDateTime(dateTimeStr) {
                if (!dateTimeStr) return '-';
                
                try {
                    const date = new Date(dateTimeStr);
                    if (isNaN(date.getTime())) return dateTimeStr;
                    
                    // 格式化为：YYYY-MM-DD HH:MM
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                } catch (e) {
                    return dateTimeStr;
                }
            }
            
            // 格式化持仓时间
            function formatHoldingTime(hours) {
                if (!hours || isNaN(hours)) return '-';
                
                const days = Math.floor(hours / 24);
                const remainingHours = Math.floor(hours % 24);
                const minutes = Math.floor((hours * 60) % 60);
                
                if (days > 0) {
                    return `${days}天${remainingHours}小时`;
                } else if (remainingHours > 0) {
                    return `${remainingHours}小时${minutes}分`;
                } else {
                    return `${minutes}分钟`;
                }
            }
            
            // 渲染活跃订单
            function renderActiveOrders() {
                const container = document.getElementById('active-orders-table');
                const filteredOrders = applyFilters(state.activeOrders, 'active');
                
                if (!filteredOrders || filteredOrders.length === 0) {
                    container.innerHTML = '<tr><td colspan="10" class="text-center p-3">暂无活跃订单</td></tr>';
                    return;
                }
                
                let html = '';
                
                filteredOrders.forEach(order => {
                    const isLong = order.direction === '多';
                    const currentPrice = parseFloat(order.current_price);
                    const entryPrice = parseFloat(order.entry_price);
                    
                    // 计算价格变化百分比
                    let priceChange = 0;
                    if (entryPrice && currentPrice) {
                        if (isLong) {
                            priceChange = ((currentPrice - entryPrice) / entryPrice) * 100;
                        } else {
                            priceChange = ((entryPrice - currentPrice) / entryPrice) * 100;
                        }
                    }
                    
                    // 计算风险收益比
                    let riskRewardRatio = order.risk_reward_ratio ? order.risk_reward_ratio.toFixed(2) : '-';
                    
                    // 计算持仓时间
                    let holdingTime = '-';
                    if (order.avg_hold_time) {
                        holdingTime = formatHoldingTime(order.avg_hold_time);
                    } else if (order.entry_time) {
                        const entryDate = new Date(order.entry_time);
                        const currentDate = new Date();
                        const diffTime = Math.abs(currentDate - entryDate);
                        const diffHours = diffTime / (1000 * 60 * 60);
                        holdingTime = formatHoldingTime(diffHours);
                    }
                    
                    // 确定CSS类
                    const priceChangeClass = priceChange >= 0 ? 'profit' : 'loss';
                    const directionClass = isLong ? 'direction-long' : 'direction-short';
                    
                    html += `
                    <tr class="${directionClass}">
                        <td>${order.channel || '-'}</td>
                        <td>${order.symbol}</td>
                        <td><span class="badge ${isLong ? 'status-active' : 'status-completed'}">${order.direction}</span></td>
                        <td>${formatDateTime(order.entry_time)}</td>
                        <td>${order.entry_price || '-'}</td>
                        <td class="${priceChangeClass}">${currentPrice ? currentPrice.toFixed(2) : '-'}</td>
                        <td>${order.stop_loss || '-'}</td>
                        <td>${order.target_price || '-'}</td>
                        <td class="${priceChangeClass}">${priceChange ? priceChange.toFixed(2) + '%' : '-'}</td>
                        <td>${riskRewardRatio}</td>
                        <td>${holdingTime}</td>
                    </tr>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            // 渲染已完成订单
            function renderCompletedOrders() {
                const container = document.getElementById('completed-orders-table');
                const filteredOrders = applyFilters(state.completedOrders, 'completed');
                
                if (!filteredOrders || filteredOrders.length === 0) {
                    container.innerHTML = '<tr><td colspan="12" class="text-center p-3">暂无已完成订单</td></tr>';
                    return;
                }
                
                let html = '';
                
                filteredOrders.forEach(order => {
                    const isLong = order.direction === '多';
                    const exitPrice = parseFloat(order.exit_price);
                    const entryPrice = parseFloat(order.entry_price);
                    
                    // 计算价格变化百分比
                    let priceChange = 0;
                    if (entryPrice && exitPrice) {
                        if (isLong) {
                            priceChange = ((exitPrice - entryPrice) / entryPrice) * 100;
                        } else {
                            priceChange = ((entryPrice - exitPrice) / entryPrice) * 100;
                        }
                    }
                    
                    // 计算风险收益比
                    let riskRewardRatio = order.risk_reward_ratio ? order.risk_reward_ratio.toFixed(2) : '-';
                    
                    // 计算持仓时间
                    let holdingTime = '-';
                    if (order.avg_hold_time) {
                        holdingTime = formatHoldingTime(order.avg_hold_time);
                    } else if (order.entry_time && order.exit_time) {
                        const entryDate = new Date(order.entry_time);
                        const exitDate = new Date(order.exit_time);
                        const diffTime = Math.abs(exitDate - entryDate);
                        const diffHours = diffTime / (1000 * 60 * 60);
                        holdingTime = formatHoldingTime(diffHours);
                    }
                    
                    // 确定CSS类
                    const profitClass = priceChange >= 0 ? 'profit' : 'loss';
                    const directionClass = isLong ? 'direction-long' : 'direction-short';
                    const resultText = priceChange >= 0 ? '盈利' : '亏损';
                    
                    html += `
                    <tr class="${directionClass}">
                        <td>${order.channel || '-'}</td>
                        <td>${order.symbol}</td>
                        <td><span class="badge ${isLong ? 'status-active' : 'status-completed'}">${order.direction}</span></td>
                        <td>${formatDateTime(order.entry_time)}</td>
                        <td>${order.entry_price || '-'}</td>
                        <td>${order.exit_price || '-'}</td>
                        <td>${formatDateTime(order.exit_time)}</td>
                        <td>${order.stop_loss || '-'}</td>
                        <td>${order.target_price || '-'}</td>
                        <td class="${profitClass}">${priceChange ? priceChange.toFixed(2) + '%' : '-'}</td>
                        <td class="${profitClass}">${resultText}</td>
                        <td>${holdingTime}</td>
                        <td>${riskRewardRatio}</td>
                    </tr>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            // 添加列筛选器
            function addColumnFilters(tableId, columns) {
                // 为每个表头添加筛选菜单
                document.querySelectorAll(`#${tableId} th[data-sort]`).forEach(th => {
                    const field = th.dataset.sort;
                    const column = columns.find(col => col.field === field);
                    
                    if (!column) return;
                    
                    // 创建一个专门的筛选按钮
                    const filterButton = document.createElement('button');
                    filterButton.type = 'button';
                    filterButton.className = 'filter-icon';
                    filterButton.innerHTML = '▼';
                    filterButton.title = `筛选${column.label || field}`;
                    filterButton.style.position = 'absolute';
                    filterButton.style.right = '5px';
                    filterButton.style.top = '50%';
                    filterButton.style.transform = 'translateY(-50%)';
                    filterButton.style.background = 'rgba(255,255,255,0.2)';
                    filterButton.style.border = 'none';
                    filterButton.style.color = 'white';
                    filterButton.style.width = '18px';
                    filterButton.style.height = '18px';
                    filterButton.style.fontSize = '8px';
                    filterButton.style.padding = '0';
                    filterButton.style.textAlign = 'center';
                    filterButton.style.lineHeight = '18px';
                    filterButton.style.borderRadius = '3px';
                    filterButton.style.zIndex = '100';
                    filterButton.style.cursor = 'pointer';
                    
                    // 创建筛选菜单
                    const filterMenu = document.createElement('div');
                    filterMenu.className = 'filter-menu';
                    filterMenu.style.display = 'none';
                    filterMenu.style.position = 'absolute';
                    filterMenu.style.backgroundColor = '#fff';
                    filterMenu.style.border = '1px solid #ddd';
                    filterMenu.style.borderRadius = '4px';
                    filterMenu.style.padding = '10px';
                    filterMenu.style.zIndex = '1000';
                    filterMenu.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                    filterMenu.style.minWidth = '180px';
                    filterMenu.style.maxWidth = '300px';
                    filterMenu.style.marginTop = '5px';
                    
                    // 构建筛选菜单内容
                    if (column.isNumeric) {
                        // 数值型筛选器
                        filterMenu.innerHTML = `
                            <div class="form-group mb-2">
                                <label class="form-label">最小值</label>
                                <input type="number" class="form-control form-control-sm" placeholder="最小值" data-filter-min="${field}">
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">最大值</label>
                                <input type="number" class="form-control form-control-sm" placeholder="最大值" data-filter-max="${field}">
                            </div>
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-primary apply-filter" data-field="${field}">应用</button>
                                <button class="btn btn-sm btn-secondary clear-filter" data-field="${field}">清除</button>
                            </div>
                        `;
                    } else if (column.options) {
                        // 选项型筛选器
                        let optionsHtml = '';
                        column.options.forEach(option => {
                            optionsHtml += `
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" value="${option}" id="${field}_${option}">
                                    <label class="form-check-label" for="${field}_${option}">${option}</label>
                                </div>
                            `;
                        });
                        
                        filterMenu.innerHTML = `
                            <div class="mb-3">
                                ${optionsHtml}
                            </div>
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-primary apply-filter" data-field="${field}">应用</button>
                                <button class="btn btn-sm btn-secondary clear-filter" data-field="${field}">清除</button>
                            </div>
                        `;
                    } else {
                        // 文本型筛选器
                        filterMenu.innerHTML = `
                            <div class="form-group mb-3">
                                <label class="form-label">关键词</label>
                                <input type="text" class="form-control form-control-sm" placeholder="输入关键词" data-filter-text="${field}">
                            </div>
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-primary apply-filter" data-field="${field}">应用</button>
                                <button class="btn btn-sm btn-secondary clear-filter" data-field="${field}">清除</button>
                            </div>
                        `;
                    }
                    
                    // 添加筛选菜单到文档
                    document.body.appendChild(filterMenu);
                    
                    // 添加筛选图标到表头
                    th.appendChild(filterButton);
                    
                    // 筛选按钮点击事件
                    filterButton.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault(); // 阻止默认事件
                        
                        // 获取按钮位置
                        const buttonRect = this.getBoundingClientRect();
                        
                        // 检查菜单当前是否显示
                        const isMenuVisible = filterMenu.style.display === 'block';
                        
                        // 隐藏所有其他筛选菜单
                        document.querySelectorAll('.filter-menu').forEach(menu => {
                            menu.style.display = 'none';
                        });
                        
                        // 切换当前筛选菜单显示状态
                        if (isMenuVisible) {
                            filterMenu.style.display = 'none';
                        } else {
                            // 设置筛选菜单位置
                            filterMenu.style.left = `${buttonRect.left}px`;
                            filterMenu.style.top = `${buttonRect.bottom + window.scrollY}px`;
                            filterMenu.style.display = 'block';
                            
                            // 预填充当前筛选值
                            if (window.tableFilters && window.tableFilters[tableId] && window.tableFilters[tableId][field]) {
                                const filter = window.tableFilters[tableId][field];
                                if (filter.type === 'numeric') {
                                    const minInput = filterMenu.querySelector(`[data-filter-min="${field}"]`);
                                    const maxInput = filterMenu.querySelector(`[data-filter-max="${field}"]`);
                                    if (minInput && filter.min !== null) minInput.value = filter.min;
                                    if (maxInput && filter.max !== null) maxInput.value = filter.max;
                                } else if (filter.type === 'options') {
                                    filter.values.forEach(value => {
                                        const checkbox = filterMenu.querySelector(`#${field}_${value}`);
                                        if (checkbox) checkbox.checked = true;
                                    });
                                } else if (filter.type === 'text') {
                                    const textInput = filterMenu.querySelector(`[data-filter-text="${field}"]`);
                                    if (textInput) textInput.value = filter.value;
                                }
                            }
                        }
                    });
                    
                    // 防止筛选菜单点击冒泡
                    filterMenu.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                    
                    // 应用筛选按钮事件
                    const applyFilterBtn = filterMenu.querySelector('.apply-filter');
                    applyFilterBtn.addEventListener('click', function(e) {
                        const field = this.dataset.field;
                        let hasFilter = false;
                        
                        // 创建全局筛选状态存储
                        window.tableFilters = window.tableFilters || {};
                        window.tableFilters[tableId] = window.tableFilters[tableId] || {};
                        
                        if (column.isNumeric) {
                            const minInput = filterMenu.querySelector(`[data-filter-min="${field}"]`);
                            const maxInput = filterMenu.querySelector(`[data-filter-max="${field}"]`);
                            
                            if (minInput && maxInput) {
                                const minVal = minInput.value !== '' ? parseFloat(minInput.value) : null;
                                const maxVal = maxInput.value !== '' ? parseFloat(maxInput.value) : null;
                                
                                if (minVal !== null || maxVal !== null) {
                                    // 保存筛选状态
                                    window.tableFilters[tableId][field] = {
                                        type: 'numeric',
                                        min: minVal,
                                        max: maxVal
                                    };
                                    hasFilter = true;
                                }
                            }
                        } else if (column.options) {
                            const checkedOptions = [];
                            column.options.forEach(option => {
                                const checkbox = filterMenu.querySelector(`#${field}_${option}`);
                                if (checkbox && checkbox.checked) {
                                    checkedOptions.push(option);
                                }
                            });
                            
                            if (checkedOptions.length > 0) {
                                // 保存筛选状态
                                window.tableFilters[tableId][field] = {
                                    type: 'options',
                                    values: checkedOptions
                                };
                                hasFilter = true;
                            }
                        } else {
                            const textInput = filterMenu.querySelector(`[data-filter-text="${field}"]`);
                            
                            if (textInput && textInput.value.trim() !== '') {
                                // 保存筛选状态
                                window.tableFilters[tableId][field] = {
                                    type: 'text',
                                    value: textInput.value.trim()
                                };
                                hasFilter = true;
                            }
                        }
                        
                        if (hasFilter) {
                            // 显示筛选状态
                            th.classList.add('filtered');
                            filterButton.classList.add('active-filter');
                        }
                        
                        // 重新渲染表格
                        if (tableId === 'active-orders-table') {
                            renderActiveOrders();
                        } else if (tableId === 'completed-orders-table') {
                            renderCompletedOrders();
                        }
                        
                        // 隐藏筛选菜单
                        filterMenu.style.display = 'none';
                    });
                    
                    // 清除筛选按钮事件
                    const clearFilterBtn = filterMenu.querySelector('.clear-filter');
                    clearFilterBtn.addEventListener('click', function(e) {
                        const field = this.dataset.field;
                        
                        // 清除筛选状态
                        if (window.tableFilters && window.tableFilters[tableId]) {
                            delete window.tableFilters[tableId][field];
                        }
                        
                        // 移除筛选状态标记
                        th.classList.remove('filtered');
                        filterButton.classList.remove('active-filter');
                        
                        // 清空输入框
                        if (column.isNumeric) {
                            const minInput = filterMenu.querySelector(`[data-filter-min="${field}"]`);
                            const maxInput = filterMenu.querySelector(`[data-filter-max="${field}"]`);
                            
                            if (minInput) minInput.value = '';
                            if (maxInput) maxInput.value = '';
                        } else if (column.options) {
                            column.options.forEach(option => {
                                const checkbox = filterMenu.querySelector(`#${field}_${option}`);
                                if (checkbox) checkbox.checked = false;
                            });
                        } else {
                            const textInput = filterMenu.querySelector(`[data-filter-text="${field}"]`);
                            if (textInput) textInput.value = '';
                        }
                        
                        // 重新渲染表格
                        if (tableId === 'active-orders-table') {
                            renderActiveOrders();
                        } else if (tableId === 'completed-orders-table') {
                            renderCompletedOrders();
                        }
                        
                        // 隐藏筛选菜单
                        filterMenu.style.display = 'none';
                    });
                });
                
                // 点击其他地方关闭筛选菜单
                document.addEventListener('click', function(e) {
                    // 如果点击的不是筛选菜单内部元素，也不是筛选按钮
                    if (!e.target.closest('.filter-menu') && !e.target.classList.contains('filter-icon')) {
                        document.querySelectorAll('.filter-menu').forEach(menu => {
                            menu.style.display = 'none';
                        });
                    }
                });
            }
            
            // 添加表头筛选功能
            function addTableFilters() {
                // 为活跃订单表添加筛选和排序
                document.querySelectorAll('#active-orders th[data-sort]').forEach(th => {
                    // 添加排序图标
                    const sortIcon = document.createElement('span');
                    sortIcon.innerHTML = '⇕';
                    sortIcon.className = 'sort-icon';
                    th.appendChild(sortIcon);
                    
                    // 添加点击排序事件
                    th.addEventListener('click', function(e) {
                        // 如果点击的是筛选按钮，则不进行排序
                        if (e.target.closest('.filter-icon')) return;
                        
                        const sortField = this.dataset.sort;
                        const currentSort = document.getElementById('activeOrderSort').value;
                        
                        // 切换排序方向
                        let newSort;
                        if (currentSort.startsWith(sortField)) {
                            newSort = currentSort.endsWith('_asc') ? `${sortField}_desc` : `${sortField}_asc`;
                        } else {
                            newSort = `${sortField}_asc`;
                        }
                        
                        // 更新排序下拉框
                        document.getElementById('activeOrderSort').value = newSort;
                        
                        // 更新表格
                        renderActiveOrders();
                    });
                });
                
                // 为已完成订单表添加筛选和排序
                document.querySelectorAll('#completed-orders th[data-sort]').forEach(th => {
                    // 添加排序图标
                    const sortIcon = document.createElement('span');
                    sortIcon.innerHTML = '⇕';
                    sortIcon.className = 'sort-icon';
                    th.appendChild(sortIcon);
                    
                    // 添加点击排序事件
                    th.addEventListener('click', function(e) {
                        // 如果点击的是筛选按钮，则不进行排序
                        if (e.target.closest('.filter-icon')) return;
                        
                        const sortField = this.dataset.sort;
                        const currentSort = document.getElementById('orderSort').value;
                        
                        // 切换排序方向
                        let newSort;
                        if (currentSort.startsWith(sortField)) {
                            newSort = currentSort.endsWith('_asc') ? `${sortField}_desc` : `${sortField}_asc`;
                        } else {
                            newSort = `${sortField}_asc`;
                        }
                        
                        // 更新排序下拉框
                        document.getElementById('orderSort').value = newSort;
                        
                        // 更新表格
                        renderCompletedOrders();
                    });
                });
                
                // 添加下拉筛选器事件监听
                document.getElementById('activeSymbolFilter').addEventListener('change', renderActiveOrders);
                document.getElementById('activeChannelFilter').addEventListener('change', renderActiveOrders);
                document.getElementById('activeDirectionFilter').addEventListener('change', renderActiveOrders);
                document.getElementById('activePnlFilter').addEventListener('change', renderActiveOrders);
                document.getElementById('activeOrderSort').addEventListener('change', renderActiveOrders);
                
                document.getElementById('symbolFilter').addEventListener('change', renderCompletedOrders);
                document.getElementById('channelFilter').addEventListener('change', renderCompletedOrders);
                document.getElementById('directionFilter').addEventListener('change', renderCompletedOrders);
                document.getElementById('resultFilter').addEventListener('change', renderCompletedOrders);
                document.getElementById('orderSort').addEventListener('change', renderCompletedOrders);
            }
            
            // 应用表格筛选
            function applyTableFilters(tableId, orders) {
                if (!window.tableFilters || !window.tableFilters[tableId]) {
                    return orders;
                }
                
                return orders.filter(order => {
                    let shouldInclude = true;
                    
                    // 遍历所有应用的筛选条件
                    Object.entries(window.tableFilters[tableId]).forEach(([field, filter]) => {
                        // 如果已经被过滤掉了，则不再继续检查
                        if (!shouldInclude) return;
                        
                        const value = order[field];
                        
                        // 根据不同的筛选类型进行处理
                        if (filter.type === 'numeric') {
                            const numValue = parseFloat(value);
                            
                            if (isNaN(numValue)) {
                                shouldInclude = false;
                                return;
                            }
                            
                            if (filter.min !== null && numValue < filter.min) {
                                shouldInclude = false;
                                return;
                            }
                            
                            if (filter.max !== null && numValue > filter.max) {
                                shouldInclude = false;
                                return;
                            }
                        } else if (filter.type === 'options') {
                            if (!filter.values.includes(value)) {
                                shouldInclude = false;
                                return;
                            }
                        } else if (filter.type === 'text') {
                            if (!value || !value.toString().toLowerCase().includes(filter.value.toLowerCase())) {
                                shouldInclude = false;
                                return;
                            }
                        }
                    });
                    
                    return shouldInclude;
                });
            }
            
            // 应用筛选
            function applyFilters(orders, type) {
                if (!orders || orders.length === 0) return [];
                
                // 应用基本筛选
                let filteredOrders = [...orders];
                const tableId = type === 'active' ? 'active-orders-table' : 'completed-orders-table';
                
                if (type === 'active') {
                    const symbolFilter = document.getElementById('activeSymbolFilter').value;
                    const channelFilter = document.getElementById('activeChannelFilter').value;
                    const directionFilter = document.getElementById('activeDirectionFilter').value;
                    const pnlFilter = document.getElementById('activePnlFilter').value;
                    
                    filteredOrders = filteredOrders.filter(order => {
                        let match = true;
                        
                        if (symbolFilter && order.symbol.includes(symbolFilter.replace('USDT', ''))) {
                            match = true;
                        } else if (symbolFilter) {
                            match = false;
                        }
                        
                        if (channelFilter && order.channel !== channelFilter) {
                            match = false;
                        }
                        
                        if (directionFilter && order.direction !== directionFilter) {
                            match = false;
                        }
                        
                        if (pnlFilter) {
                            const pnlValue = order.current_pnl || 0;
                            const isProfitable = (pnlValue > 0);
                            if ((pnlFilter === '盈利' && !isProfitable) || 
                                (pnlFilter === '亏损' && isProfitable)) {
                                match = false;
                            }
                        }
                        
                        return match;
                    });
                    
                    // 应用表头筛选
                    filteredOrders = applyTableFilters(tableId, filteredOrders);
                    
                    // 应用排序
                    const sortOption = document.getElementById('activeOrderSort').value;
                    sortOrders(filteredOrders, sortOption);
                    
                } else if (type === 'completed') {
                    const symbolFilter = document.getElementById('symbolFilter').value;
                    const channelFilter = document.getElementById('channelFilter').value;
                    const directionFilter = document.getElementById('directionFilter').value;
                    const resultFilter = document.getElementById('resultFilter').value;
                    
                    filteredOrders = filteredOrders.filter(order => {
                        let match = true;
                        
                        if (symbolFilter && order.symbol.includes(symbolFilter.replace('USDT', ''))) {
                            match = true;
                        } else if (symbolFilter) {
                            match = false;
                        }
                        
                        if (channelFilter && order.channel !== channelFilter) {
                            match = false;
                        }
                        
                        if (directionFilter && order.direction !== directionFilter) {
                            match = false;
                        }
                        
                        if (resultFilter) {
                            const isProfitable = (order.profit_pct > 0);
                            if ((resultFilter === '盈利' && !isProfitable) || 
                                (resultFilter === '亏损' && isProfitable)) {
                                match = false;
                            }
                        }
                        
                        return match;
                    });
                    
                    // 应用表头筛选
                    filteredOrders = applyTableFilters(tableId, filteredOrders);
                    
                    // 应用排序
                    const sortOption = document.getElementById('orderSort').value;
                    sortOrders(filteredOrders, sortOption);
                }
                
                return filteredOrders;
            }
            
            // 排序订单
            function sortOrders(orders, sortOption) {
                try {
                    switch (sortOption) {
                        case 'time_desc':
                            orders.sort((a, b) => {
                                const dateA = a.entry_time ? new Date(a.entry_time) : new Date(0);
                                const dateB = b.entry_time ? new Date(b.entry_time) : new Date(0);
                                return dateB - dateA;
                            });
                            break;
                        case 'time_asc':
                            orders.sort((a, b) => {
                                const dateA = a.entry_time ? new Date(a.entry_time) : new Date(0);
                                const dateB = b.entry_time ? new Date(b.entry_time) : new Date(0);
                                return dateA - dateB;
                            });
                            break;
                        case 'pnl_desc':
                            orders.sort((a, b) => {
                                const pnlA = a.current_pnl || a.profit_pct || 0;
                                const pnlB = b.current_pnl || b.profit_pct || 0;
                                return pnlB - pnlA;
                            });
                            break;
                        case 'pnl_asc':
                            orders.sort((a, b) => {
                                const pnlA = a.current_pnl || a.profit_pct || 0;
                                const pnlB = b.current_pnl || b.profit_pct || 0;
                                return pnlA - pnlB;
                            });
                            break;
                    }
                } catch (error) {
                    console.error('排序时出错:', error);
                }
            }
            
            // 显示提示框
            function showAlert(title, message, type) {
                const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <strong>${title}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
                
                document.getElementById('alertContainer').insertAdjacentHTML('beforeend', alertHtml);
                
                // 自动关闭
                setTimeout(() => {
                    const alerts = document.querySelectorAll('.alert');
                    if (alerts.length) {
                        alerts[0].remove();
                    }
                }, 5000);
            }
            
            // 初始化
            function init() {
                initCharts();
                
                // 添加表头筛选功能
                addTableFilters();
                
                // 添加高级列筛选功能
                addColumnFilters('active-orders-table', [
                    { field: 'channel', label: '频道' },
                    { field: 'symbol', label: '交易币种' },
                    { field: 'direction', label: '方向', options: ['多', '空'] },
                    { field: 'entry_price', label: '入场价格', isNumeric: true },
                    { field: 'current_price', label: '当前价格', isNumeric: true },
                    { field: 'stop_loss', label: '止损价格', isNumeric: true },
                    { field: 'target_price', label: '目标价格', isNumeric: true },
                    { field: 'current_pnl', label: '当前盈亏', isNumeric: true },
                    { field: 'risk_reward', label: '风险收益比', isNumeric: true }
                ]);
                
                addColumnFilters('completed-orders-table', [
                    { field: 'channel', label: '频道' },
                    { field: 'symbol', label: '交易币种' },
                    { field: 'direction', label: '方向', options: ['多', '空'] },
                    { field: 'entry_price', label: '入场价格', isNumeric: true },
                    { field: 'exit_price', label: '出场价格', isNumeric: true },
                    { field: 'profit_pct', label: '盈亏', isNumeric: true },
                    { field: 'result', label: '结果', options: ['盈利', '亏损'] }
                ]);
            }
            
            // 监听WebSocket事件
            socket.on('connect', function() {
                console.log('已连接到服务器');
                showAlert('连接成功', '已连接到订单追踪服务器', 'success');
            });
            
            socket.on('disconnect', function() {
                console.log('与服务器断开连接');
                showAlert('断开连接', '与订单追踪服务器断开连接', 'danger');
                state.isMonitoring = false;
            });
            
            socket.on('initial_data', function(data) {
                state.activeOrders = data.active_orders;
                state.completedOrders = data.completed_orders;
                
                renderActiveOrders();
                renderCompletedOrders();
                updateStats();
            });
            
            socket.on('order_update', function(data) {
                state.activeOrders = data.active_orders;
                state.lastUpdate = new Date();
                
                renderActiveOrders();
                updateStats();
            });
            
            socket.on('monitoring_status', function(data) {
                state.isMonitoring = data.is_monitoring;
                document.getElementById('startBtn').disabled = state.isMonitoring;
                document.getElementById('stopBtn').disabled = !state.isMonitoring;
                
                if (state.isMonitoring) {
                    showAlert('监控开始', '订单价格监控已开始', 'success');
                } else {
                    showAlert('监控停止', '订单价格监控已停止', 'warning');
                }
            });
            
            // 按钮事件监听
            document.getElementById('startBtn').addEventListener('click', function() {
                socket.emit('start_monitoring');
            });
            
            document.getElementById('stopBtn').addEventListener('click', function() {
                socket.emit('stop_monitoring');
            });
            
            document.getElementById('refreshBtn').addEventListener('click', function() {
                socket.emit('refresh_data');
                showAlert('刷新', '正在刷新订单数据...', 'info');
            });
            
            document.getElementById('intervalSelect').addEventListener('change', function() {
                const interval = parseInt(this.value);
                socket.emit('set_interval', { interval: interval });
                showAlert('设置', `刷新间隔已修改为 ${interval} 秒`, 'info');
            });
            
            // 初始化
            init();
        });
    </script>
</body>
</html>