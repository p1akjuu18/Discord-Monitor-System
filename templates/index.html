<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>币安价格监控</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        .price-up {
            color: green;
            transition: color 0.5s;
        }
        .price-down {
            color: red;
            transition: color 0.5s;
        }
        .price-card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .price-card:hover {
            transform: translateY(-5px);
        }
        .last-update {
            font-size: 0.8rem;
            color: #666;
        }
        .csv-status-card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .csv-status-info {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">币安价格实时监控</h1>
        
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button id="startBtn" class="btn btn-success me-2">开始监控</button>
                <button id="stopBtn" class="btn btn-danger me-2">停止监控</button>
                <button id="refreshCsvBtn" class="btn btn-primary">刷新CSV文件</button>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6 mx-auto">
                <div class="card csv-status-card">
                    <div class="card-header bg-info text-white">
                        <h4>CSV文件状态</h4>
                    </div>
                    <div class="card-body">
                        <div class="csv-status-info" id="csvFileName">文件名: --</div>
                        <div class="csv-status-info" id="csvFileSize">文件大小: --</div>
                        <div class="csv-status-info" id="csvLastModified">上次修改: --</div>
                        <div class="csv-status-info" id="csvLastChecked">上次检查: --</div>
                        <div class="csv-status-info" id="csvOrderCount">活跃订单: --</div>
                        <div class="alert alert-info mt-2" id="csvStatusMessage" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row" id="priceCards">
            {% for symbol in symbols %}
            <div class="col-md-4">
                <div class="card price-card">
                    <div class="card-header bg-primary text-white">
                        <h3>{{ symbol.upper() }}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-4 text-center">
                                <h5>买入价</h5>
                                <h4 id="{{ symbol.upper() }}_bid">--</h4>
                            </div>
                            <div class="col-4 text-center">
                                <h5>中间价</h5>
                                <h4 id="{{ symbol.upper() }}_mid">--</h4>
                            </div>
                            <div class="col-4 text-center">
                                <h5>卖出价</h5>
                                <h4 id="{{ symbol.upper() }}_ask">--</h4>
                            </div>
                        </div>
                        <div class="text-end mt-3">
                            <span class="last-update" id="{{ symbol.upper() }}_timestamp">从未更新</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.6.1/dist/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 连接到WebSocket服务器
            const socket = io();
            
            // 存储上一次价格，用于比较
            const lastPrices = {};
            
            // 监听价格更新事件
            socket.on('price_update', function(data) {
                const symbol = data.symbol;
                const bid = data.bid;
                const ask = data.ask;
                const mid = data.mid;
                
                // 更新显示
                updatePrice(`${symbol}_bid`, bid, lastPrices[`${symbol}_bid`]);
                updatePrice(`${symbol}_ask`, ask, lastPrices[`${symbol}_ask`]);
                updatePrice(`${symbol}_mid`, mid, lastPrices[`${symbol}_mid`]);
                
                // 更新时间戳
                document.getElementById(`${symbol}_timestamp`).textContent = `更新于: ${getCurrentTime()}`;
                
                // 存储最新价格
                lastPrices[`${symbol}_bid`] = bid;
                lastPrices[`${symbol}_ask`] = ask;
                lastPrices[`${symbol}_mid`] = mid;
            });
            
            // 监听订单更新事件
            socket.on('orders_update', function(data) {
                if (data.active_orders) {
                    document.getElementById('csvOrderCount').textContent = `活跃订单: ${data.active_orders.length}`;
                }
                
                if (data.message) {
                    showStatusMessage(data.message);
                }
            });
            
            // 监听CSV状态更新事件
            socket.on('csv_status', function(data) {
                document.getElementById('csvFileName').textContent = `文件名: ${data.filename || '--'}`;
                document.getElementById('csvFileSize').textContent = `文件大小: ${data.file_size || '--'}`;
                document.getElementById('csvLastModified').textContent = `上次修改: ${data.last_modified || '--'}`;
                document.getElementById('csvLastChecked').textContent = `上次检查: ${data.last_checked || '--'}`;
                
                if (data.message) {
                    showStatusMessage(data.message);
                }
            });
            
            // 更新价格并添加颜色变化效果
            function updatePrice(elementId, newPrice, lastPrice) {
                const element = document.getElementById(elementId);
                element.textContent = newPrice.toFixed(2);
                
                // 清除现有的颜色类
                element.classList.remove('price-up', 'price-down');
                
                // 根据价格变化添加颜色类
                if (lastPrice !== undefined) {
                    if (newPrice > lastPrice) {
                        element.classList.add('price-up');
                    } else if (newPrice < lastPrice) {
                        element.classList.add('price-down');
                    }
                }
            }
            
            // 获取当前时间
            function getCurrentTime() {
                const now = new Date();
                return now.toLocaleTimeString();
            }
            
            // 显示状态消息
            function showStatusMessage(message) {
                const messageElement = document.getElementById('csvStatusMessage');
                messageElement.textContent = message;
                messageElement.style.display = 'block';
                
                // 5秒后自动隐藏消息
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000);
            }
            
            // 开始和停止监控按钮事件
            document.getElementById('startBtn').addEventListener('click', function() {
                socket.emit('start_monitoring');
            });
            
            document.getElementById('stopBtn').addEventListener('click', function() {
                socket.emit('stop_monitoring');
            });
            
            // CSV刷新按钮事件
            document.getElementById('refreshCsvBtn').addEventListener('click', function() {
                socket.emit('refresh_csv');
                showStatusMessage('正在刷新CSV文件...');
            });
            
            // 连接建立后自动获取CSV状态
            socket.on('connect', function() {
                console.log('已连接到服务器');
                socket.emit('get_csv_status');
            });
            
            // 每30秒自动获取一次CSV状态
            setInterval(() => {
                socket.emit('get_csv_status');
            }, 30000);
        });
    </script>
</body>
</html>